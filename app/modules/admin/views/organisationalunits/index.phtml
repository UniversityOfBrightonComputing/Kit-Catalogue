<?php
$this->layout()->addGlobalJavascript();

$this->layout()->appendSection('layout.head', '
<style type="text/css">

span.treecontrols { display: inline-block; margin-left: 1em; }


#modalmask {
	position:absolute;
	display:none;

	z-index:9000;
	background-color:#000;
}

.window {
	position: fixed;
	display: none;
	width: 500px;
	height: 300px;
	z-index: 9999;

	padding: 1em;
	background-color: #e0e0e0;
	border: 1px solid #999;
	border-radius: 10px;
}

.window .closemodal { float: right; margin: -0.8em -0.5em 0 0; color: #666; font-weight: bold; }


</style>
<script type="text/javascript">

$(document).ready( function() {


	jQuery.showmodal = function showmodal(obj) {
		var fadespeed = 400;

		var doc_width = $(document).width();
		var doc_height = $(document).height();

		var win_width = $(window).width();
		var win_height = $(window).height();

		var mask_width = (doc_width > win_width) ? doc_width : win_width ;
		var mask_height = (doc_height > win_height) ? doc_height : win_height ;

		$("#modalmask").css({
			"width" : mask_width,
			"height": mask_height
		}).fadeTo(fadespeed, 0.80);

		obj.css({
			"top" : (win_height/2) - (obj.height()/2) ,
			"left": (win_width/2) - (obj.width()/2)
		}).addClass("activewindow").fadeIn(fadespeed);
	}


	$(window).resize(function () {
		var obj = $(".activewindow");

		if (obj.length > 0) {
			var doc_width = $(document).width();
			var doc_height = $(document).height();

			var win_width = $(window).width();
			var win_height = $(window).height();

			var mask_width = (doc_width > win_width) ? doc_width : win_width ;
			var mask_height = (doc_height > win_height) ? doc_height : win_height ;

			$("#modalmask").css({
				"width" : mask_width,
				"height": mask_height
			});

			obj.css({
				"top" : (win_height/2) - (obj.height()/2) ,
				"left": (win_width/2) - (obj.width()/2)
			});
		}
	});


	$("body").prepend("<div id=\"modalmask\"></div>");


	$("a.tree_add").on("click", function(e) {
		e.preventDefault();
		var ou_id = $(this).closest("li").data("ouid");
		$("#ouid").val(ou_id);
		showmodal($("#add_window"));
	});


    $(".closemodal").on("click", function (e) {
        e.preventDefault();
        $("#modalmask").hide();
		$(".activewindow").removeClass("activewindow").hide();
    });

});

</script>
');


$window_to_show = $this->param('window_to_show');

if ('add_window' == $window_to_show) {
	$this->layout()->appendSection('layout.head', '
	<script type="text/javascript">

		$(document).ready( function() {

			$("#add_window input[name=\"ou_name\"]").val("'. $this->escape($this->window_ou->name) .'");
			$("#add_window input[name=\"ou_url\"]").val("'. $this->escape($this->window_ou->url) .'");

			$.showmodal($("#add_window"));

		});

	</script>
	');
}
?>

<h1>Administer <?php $this->out($this->model('lang')->get('ou.label.adminsection')); ?></h1>

<div class="cf">


	<p>Below is the organisational tree for this catalogue.</p>

	<?php
	if ($this->organisationalunits->count()==0) {
		?>
		<p class="warning">No organisational units have been setup yet.</p>
		<?php
	} else {
		echo('<div id="tree">');

		$ou_list = $this->organisationalunits->toArray();

		$current_level = 0;
		while (!empty($ou_list)) {
			$ou = array_shift($ou_list);

			if ($ou->tree_level > $current_level) {
				echo '<ul>';
			}

			if ($ou->tree_level < $current_level) {
				echo str_repeat('</ul>', $current_level - $ou->tree_level);
			}

			printf('<li data-ouid="%1$s"> %2$s', $ou->id, $this->escape($ou->name));

			echo '<span class="treecontrols">';
			echo '[<a class="tree_add" href="#" title="add child unit">+</a>]';
			if (1 < $ou->tree_level) {
				echo '[<a class="tree_edit" href="#" title="edit unit">edit</a>]';
				echo '[<a class="tree_move" href="#" title="move unit">move</a>]';
				echo '[<a class="tree_delete" href="#" title="delete unit">x</a>]';
			}

			echo '</span>';
			echo '</li>';

			$current_level = $ou->tree_level;

			if (empty($ou_list)) {
				echo str_repeat('</ul>', $current_level + 1);
			}
		}
		echo('</div>');
	}
	?>


</div>



<div id="add_window" class="window">

	<a class="closemodal" href="#" title="close window">close</a>
	<h3>Add New Organisational Unit</h3>
	<?php
	Ecl_Helper_Html::form('categoryform', $this->router()->makeAbsoluteUri('/admin/organisationalunits/create') );
	Ecl_Helper_Html::formHidden('session_key', $this->model('user')->getSessionKey());
	Ecl_Helper_Html::formHidden('ouid', '');
	?>
	<p>Enter the details for your new organisational unit.</p>
	<dl class="form">

		<dt><label>Name</label></dt>
		<dd><input type="text" name="ou_name" size="60" maxlength="250" value="" /></dd>

		<dt><label>URL</label></dt>
		<dd><input type="text" name="ou_url" size="60" maxlength="250" value="" /></dd>

	</dl>

	<div style="margin-top: 2em; text-align: center;">
		<?php Ecl_Helper_Html::formSubmit('submitadd', 'Save Changes'); ?>
	</div>
	</form>

</div>

